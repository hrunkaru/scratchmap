<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Visited Places</title>
    <script src="d3/d3.v3.min.js"></script>
    <script src="d3/topojson.v1.min.js"></script>
    <script src="datamaps/datamaps.world.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .controls-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            min-height: 40px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
        }

        select:hover {
            border-color: #9ca3af;
        }

        select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #2563eb;
        }

        button:active {
            background: #1d4ed8;
        }

        #progressContainer {
            flex: 1;
            min-width: 280px;
            padding: 6px 10px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            display: block;
        }

        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-container {
            flex: 1;
            background: #e5e7eb;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .progress-bar-container:hover {
            background: #d1d5db;
        }

        #progressBar {
            width: 0%;
            height: 100%;
            background: #60a5fa;
            transition: width 0.3s ease;
        }

        #progressYear {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 13px;
            color: #1f2937;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
        }

        #progressText {
            min-width: 80px;
            text-align: right;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            white-space: nowrap;
        }

        #map1 {
            position: relative;
            width: 100%;
            height: 700px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        svg {
            overflow: hidden;
        }

        .hoverinfo {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 10px 15px;
            border-radius: 6px;
            pointer-events: none;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Where I've Been</h1>
        <div class="controls-container">
            <div class="control-group">
                <label for="yearFilter">Filter by year:</label>
                <select id="yearFilter">
                    <option value="all">All Years</option>
                </select>
                <button id="animateBtn">Animate by Visit Order</button>
            </div>
            <div id="progressContainer">
                <div class="progress-wrapper">
                    <div class="progress-bar-container" id="progressBarContainer">
                        <div id="progressBar"></div>
                        <div id="progressYear"></div>
                    </div>
                    <div id="progressText"></div>
                </div>
            </div>
        </div>
        <div id="map1"></div>
    </div>

    <script src="countries.js"></script>
    <script src="cities.js"></script>

    <script>
    // Extract all unique years from all visits and sort them
    function getAllYears() {
        const years = new Set();
        Object.values(COUNTRIES).forEach(country => {
            if (country.years && country.years.length > 0) {
                country.years.forEach(year => years.add(year));
            }
        });
        return Array.from(years).sort((a, b) => a - b);
    }

    // Populate year filter dropdown
    const yearFilter = document.getElementById('yearFilter');
    const allYears = getAllYears();
    allYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    });

    // Store original data
    const ORIGINAL_COUNTRIES = JSON.parse(JSON.stringify(COUNTRIES));

    // Timeline state
    let minYear = allYears.length > 0 ? allYears[0] : new Date().getFullYear();
    let maxYear = allYears.length > 0 ? allYears[allYears.length - 1] : new Date().getFullYear();
    let currentYear = maxYear;
    let isAnimating = false;

    // Create the map
    var map = new Datamap({
        scope: 'world',
        element: document.getElementById('map1'),
        projection: 'mercator',
        responsive: true,
        height: 700,
        fills: {
            defaultFill: '#B0B0B0',
            visited: '#F5D02A',
            visitedDark: '#C4A922',
            home: '#199800',
            city: '#B5F52A'
        },
        geographyConfig: {
            highlightOnHover: true,
            highlightFillColor: '#A0C0A0',
            highlightBorderColor: '#F0F0F0',
            popupOnHover: true,
            popupTemplate: function(geography, data) {
                let html = '<div class="hoverinfo"><b>' + geography.properties.name + '</b>';
                if (data && data.years && data.years.length > 0) {
                    html += '<br/>Visited: ' + data.years.join(', ');
                }
                html += '</div>';
                return html;
            },
        },
        data: COUNTRIES
    });

    // Filter countries by year (checks if year exists in any visit)
    function filterByYear(year) {
        Object.keys(COUNTRIES).forEach(code => {
            const country = ORIGINAL_COUNTRIES[code];

            // Always keep home countries visible
            if (country.fillKey === 'home') {
                COUNTRIES[code] = country;
            } else if (year === 'all') {
                COUNTRIES[code] = country;
            } else {
                // Check if the selected year exists anywhere in the years array
                if (country.years && country.years.some(y => y.toString() === year)) {
                    COUNTRIES[code] = country;
                } else {
                    COUNTRIES[code] = {fillKey: 'defaultFill'};
                }
            }
        });
        map.updateChoropleth(COUNTRIES);
    }

    // Update map to show countries up to a specific year
    function updateMapToYear(year) {
        currentYear = year;
        Object.keys(COUNTRIES).forEach(code => {
            const country = ORIGINAL_COUNTRIES[code];

            // Always keep home countries visible
            if (country.fillKey === 'home') {
                COUNTRIES[code] = country;
            } else if (country.years && country.years.length > 0) {
                // Show if first visit year is <= current year
                if (country.years[0] <= year) {
                    COUNTRIES[code] = country;
                } else {
                    COUNTRIES[code] = {fillKey: 'defaultFill'};
                }
            } else {
                COUNTRIES[code] = {fillKey: 'defaultFill'};
            }
        });
        map.updateChoropleth(COUNTRIES);
        updateProgressBar();
    }

    // Update progress bar display
    function updateProgressBar() {
        const progressBar = document.getElementById('progressBar');
        const progressYear = document.getElementById('progressYear');
        const progressText = document.getElementById('progressText');

        const yearRange = maxYear - minYear;
        const progress = yearRange > 0 ? ((currentYear - minYear) / yearRange) * 100 : 100;

        progressBar.style.width = progress + '%';
        progressYear.textContent = currentYear;

        // Count unique countries visited by their first visit year (including home)
        const visibleCount = Object.entries(ORIGINAL_COUNTRIES).filter(([code, country]) =>
            (country.fillKey === 'visited' && country.years && country.years.length > 0 && country.years[0] <= currentYear) ||
            country.fillKey === 'home'
        ).length;
        progressText.textContent = visibleCount + ' unique countries';
    }

    // Year filter event listener
    yearFilter.addEventListener('change', function() {
        if (this.value === 'all') {
            currentYear = maxYear;
            updateMapToYear(maxYear);
        } else {
            filterByYear(this.value);
        }
    });

    // Mouse interaction for progress bar
    const progressBarContainer = document.getElementById('progressBarContainer');
    let isDragging = false;

    function handleProgressBarClick(e) {
        if (isAnimating) return;

        const rect = progressBarContainer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percentage = Math.max(0, Math.min(1, x / rect.width));

        const year = Math.round(minYear + (maxYear - minYear) * percentage);
        updateMapToYear(year);
    }

    progressBarContainer.addEventListener('mousedown', (e) => {
        isDragging = true;
        handleProgressBarClick(e);
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging && !isAnimating) {
            handleProgressBarClick(e);
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    progressBarContainer.addEventListener('click', handleProgressBarClick);

    // Pop animation function for re-visited countries
    function popCountry(code, originalData) {
        // Flash to darker color
        COUNTRIES[code] = {...originalData, fillKey: 'visitedDark'};
        map.updateChoropleth(COUNTRIES);

        // Return to original color after 300ms
        setTimeout(() => {
            COUNTRIES[code] = originalData;
            map.updateChoropleth(COUNTRIES);
        }, 300);
    }

    // Animate countries in visit order
    document.getElementById('animateBtn').addEventListener('click', function() {
        if (isAnimating) return;

        isAnimating = true;

        // Reset map to show only home country
        Object.keys(COUNTRIES).forEach(code => {
            const country = ORIGINAL_COUNTRIES[code];
            if (country.fillKey === 'home') {
                COUNTRIES[code] = country;
            } else {
                COUNTRIES[code] = {fillKey: 'defaultFill'};
            }
        });
        map.updateChoropleth(COUNTRIES);

        // Set progress bar to start
        currentYear = minYear - 1; // Before first visit
        updateProgressBar();

        // Create a flat list of all visits (country, year) pairs
        const allVisits = [];
        Object.entries(ORIGINAL_COUNTRIES).forEach(([code, data]) => {
            if (data.years && data.years.length > 0 && data.fillKey !== 'home') {
                data.years.forEach(year => {
                    allVisits.push({code, data, year});
                });
            }
        });

        // Sort all visits chronologically
        allVisits.sort((a, b) => a.year - b.year);

        // Track which countries have already been visited
        const visitedCountries = new Set();

        // Animate each visit
        allVisits.forEach((visit, index) => {
            setTimeout(() => {
                currentYear = visit.year;

                if (visitedCountries.has(visit.code)) {
                    // Country already visited - trigger pop animation
                    popCountry(visit.code, visit.data);
                    updateProgressBar();
                } else {
                    // First visit - show country normally
                    COUNTRIES[visit.code] = visit.data;
                    map.updateChoropleth(COUNTRIES);
                    visitedCountries.add(visit.code);
                    updateProgressBar();
                }

                // End animation
                if (index === allVisits.length - 1) {
                    isAnimating = false;
                }
            }, index * 500); // 500ms delay between each visit
        });
    });

    // Append the cities and the map to separate groups for zooming
    var svg = d3.select('#map1').select('svg');
    var gMap = svg.append('g'); // Group for world map
    var gCities = svg.append('g'); // Separate group for cities (above the map)

    // Move all map paths into the map group
    svg.selectAll('.datamaps-subunit').each(function() {
        gMap.node().appendChild(this);
    });

    // Add cities to their separate group
    function drawCities() {
        return gCities.selectAll('.city')
            .data(CITIES)
            .enter()
            .append('circle')
            .attr('class', 'city')
            .attr('r', d => d.radius)
            .attr('fill', d => map.options.fills[d.fillKey])
            .attr('cx', d => map.latLngToXY(d.latitude, d.longitude)[0])
            .attr('cy', d => map.latLngToXY(d.latitude, d.longitude)[1])
            .on('mouseover', function(d) {
                // Add hover functionality
                d3.select(this).attr('stroke', 'black').attr('stroke-width', 2);
                var tooltip = d3.select('body').append('div')
                    .attr('class', 'hoverinfo')
                    .style('left', (d3.event.pageX + 10) + 'px')
                    .style('top', (d3.event.pageY + 10) + 'px')
                    .html(d.name + ': ' + d.date);

                d3.select(this).on('mousemove', function() {
                    tooltip
                        .style('left', (d3.event.pageX + 10) + 'px')
                        .style('top', (d3.event.pageY + 10) + 'px');
                });

                d3.select(this).on('mouseout', function() {
                    tooltip.remove();
                    d3.select(this).attr('stroke', null);
                });
            });
    }

    var cities = drawCities();

    // Enable zooming and panning
    var zoom = d3.behavior.zoom()
        .scaleExtent([1, 10]) // Zoom levels
        .on('zoom', function() {
            gMap.attr('transform', 'translate(' + d3.event.translate + ')scale(' + d3.event.scale + ')');
            gCities.attr('transform', 'translate(' + d3.event.translate + ')scale(' + d3.event.scale + ')');
        });

    // Apply zoom behavior to the SVG
    svg.call(zoom);

    // Resize listener for responsiveness
    window.addEventListener('resize', function() {
        map.resize();
    });

    // Initialize progress bar to show all countries
    updateMapToYear(maxYear);

    </script>
</body>
